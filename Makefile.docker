# Makefile pour Company Analyzer Docker
# Usage: make -f Makefile.docker <target>

.PHONY: help build up down logs status clean restart dev prod

# Variables
COMPOSE_FILE = docker-compose.full-stack.yml
PROJECT_NAME = company-analyzer

# Couleurs pour l'affichage
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

help: ## Afficher l'aide
	@echo "$(GREEN)ðŸ³ Company Analyzer - Commandes Docker$(NC)"
	@echo "================================================"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'

build: ## Construire toutes les images
	@echo "$(GREEN)ðŸ”¨ Construction des images Docker...$(NC)"
	docker-compose -f $(COMPOSE_FILE) build

build-no-cache: ## Construire les images sans cache
	@echo "$(GREEN)ðŸ”¨ Construction des images sans cache...$(NC)"
	docker-compose -f $(COMPOSE_FILE) build --no-cache

up: ## DÃ©marrer tous les services en arriÃ¨re-plan
	@echo "$(GREEN)ðŸš€ DÃ©marrage de tous les services...$(NC)"
	docker-compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)âœ… Services dÃ©marrÃ©s!$(NC)"
	@echo "ðŸ“ URLs disponibles:"
	@echo "   â€¢ Application: http://localhost"
	@echo "   â€¢ Frontend:    http://localhost:3000"
	@echo "   â€¢ API:         http://localhost:8000"
	@echo "   â€¢ Docs API:    http://localhost/docs"

up-build: ## Construire et dÃ©marrer tous les services
	@echo "$(GREEN)ðŸ”¨ Construction et dÃ©marrage...$(NC)"
	docker-compose -f $(COMPOSE_FILE) up --build -d

dev: ## DÃ©marrer en mode dÃ©veloppement (avec logs)
	@echo "$(GREEN)ðŸ› ï¸  Mode dÃ©veloppement...$(NC)"
	docker-compose -f $(COMPOSE_FILE) up --build api frontend

api-only: ## DÃ©marrer seulement l'API
	@echo "$(GREEN)ðŸ”§ DÃ©marrage API seulement...$(NC)"
	docker-compose -f $(COMPOSE_FILE) up -d api

frontend-only: ## DÃ©marrer seulement le frontend
	@echo "$(GREEN)ðŸŽ¨ DÃ©marrage Frontend seulement...$(NC)"
	docker-compose -f $(COMPOSE_FILE) up -d frontend

down: ## ArrÃªter tous les services
	@echo "$(YELLOW)â¹ï¸  ArrÃªt des services...$(NC)"
	docker-compose -f $(COMPOSE_FILE) down

down-volumes: ## ArrÃªter et supprimer les volumes
	@echo "$(RED)ðŸ—‘ï¸  ArrÃªt et suppression des volumes...$(NC)"
	docker-compose -f $(COMPOSE_FILE) down -v

restart: ## RedÃ©marrer tous les services
	@echo "$(YELLOW)ðŸ”„ RedÃ©marrage des services...$(NC)"
	docker-compose -f $(COMPOSE_FILE) restart

logs: ## Afficher les logs de tous les services
	docker-compose -f $(COMPOSE_FILE) logs -f

logs-api: ## Afficher les logs de l'API
	docker-compose -f $(COMPOSE_FILE) logs -f api

logs-frontend: ## Afficher les logs du frontend
	docker-compose -f $(COMPOSE_FILE) logs -f frontend

logs-nginx: ## Afficher les logs de Nginx
	docker-compose -f $(COMPOSE_FILE) logs -f nginx

status: ## Afficher le statut des services
	@echo "$(GREEN)ðŸ“Š Statut des services:$(NC)"
	docker-compose -f $(COMPOSE_FILE) ps

health: ## VÃ©rifier la santÃ© des services
	@echo "$(GREEN)ðŸ¥ VÃ©rification de la santÃ© des services:$(NC)"
	@echo "API Health:"
	@curl -f http://localhost:8000/health 2>/dev/null && echo " âœ… API OK" || echo " âŒ API KO"
	@echo "Frontend Health:"
	@curl -f http://localhost:3000 2>/dev/null > /dev/null && echo " âœ… Frontend OK" || echo " âŒ Frontend KO"
	@echo "Nginx Health:"
	@curl -f http://localhost/health 2>/dev/null && echo " âœ… Nginx OK" || echo " âŒ Nginx KO"

shell-api: ## Ouvrir un shell dans le conteneur API
	docker-compose -f $(COMPOSE_FILE) exec api bash

shell-frontend: ## Ouvrir un shell dans le conteneur Frontend
	docker-compose -f $(COMPOSE_FILE) exec frontend sh

shell-nginx: ## Ouvrir un shell dans le conteneur Nginx
	docker-compose -f $(COMPOSE_FILE) exec nginx sh

clean: ## Nettoyer les images et conteneurs inutilisÃ©s
	@echo "$(YELLOW)ðŸ§¹ Nettoyage des ressources Docker...$(NC)"
	docker system prune -f
	docker volume prune -f

clean-all: ## Nettoyage complet (ATTENTION: supprime tout)
	@echo "$(RED)ðŸ—‘ï¸  Nettoyage complet...$(NC)"
	docker-compose -f $(COMPOSE_FILE) down -v --rmi all
	docker system prune -a -f

stats: ## Afficher les statistiques des conteneurs
	@echo "$(GREEN)ðŸ“ˆ Statistiques des conteneurs:$(NC)"
	docker stats --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

images: ## Afficher les images du projet
	@echo "$(GREEN)ðŸ–¼ï¸  Images du projet:$(NC)"
	docker images | grep -E "(company-analyzer|REPOSITORY)"

setup: ## Configuration initiale du projet
	@echo "$(GREEN)âš™ï¸  Configuration initiale...$(NC)"
	@if [ ! -f .env ]; then \
		cp env.docker.example .env; \
		echo "$(YELLOW)ðŸ“ Fichier .env crÃ©Ã©. Veuillez le configurer avec vos variables.$(NC)"; \
	else \
		echo "$(GREEN)âœ… Fichier .env existe dÃ©jÃ .$(NC)"; \
	fi
	@echo "$(GREEN)ðŸ”§ PrÃªt Ã  dÃ©marrer! Utilisez: make up$(NC)"

test: ## Tester les services aprÃ¨s dÃ©marrage
	@echo "$(GREEN)ðŸ§ª Test des services...$(NC)"
	@sleep 5
	@echo "Test API:"
	@curl -s http://localhost:8000/health | jq . || echo "âŒ API non accessible"
	@echo "Test Frontend:"
	@curl -s http://localhost:3000 > /dev/null && echo "âœ… Frontend accessible" || echo "âŒ Frontend non accessible"

backup: ## Sauvegarder les volumes de donnÃ©es
	@echo "$(GREEN)ðŸ’¾ Sauvegarde des donnÃ©es...$(NC)"
	docker-compose -f $(COMPOSE_FILE) exec api tar czf /tmp/backup.tar.gz /app/logs /app/cache 2>/dev/null || true
	docker cp $$(docker-compose -f $(COMPOSE_FILE) ps -q api):/tmp/backup.tar.gz ./backup-$$(date +%Y%m%d-%H%M%S).tar.gz
	@echo "$(GREEN)âœ… Sauvegarde crÃ©Ã©e: backup-$$(date +%Y%m%d-%H%M%S).tar.gz$(NC)"

monitor: ## Surveiller les logs en temps rÃ©el
	@echo "$(GREEN)ðŸ‘€ Surveillance des logs (Ctrl+C pour arrÃªter)...$(NC)"
	docker-compose -f $(COMPOSE_FILE) logs -f --tail=50

prod: setup up ## Configuration et dÃ©marrage en mode production
	@echo "$(GREEN)ðŸš€ Mode production activÃ©!$(NC)"

# Targets par dÃ©faut
.DEFAULT_GOAL := help
